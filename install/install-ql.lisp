(defparameter *first-run* nil)
(let* ((ql-dir (merge-pathnames "quicklisp/" (user-homedir-pathname)))
       (ql-init (merge-pathnames "setup.lisp" ql-dir)))
  (when (not (probe-file ql-dir))
    ;;(sb-ext:run-program "/usr/bin/env" '("which" "quicklisp")
    ;;                    :input t :output t :wait t)
    ;;(when (not (= 0 (sb-ext:process-exit-code *)))
    ;;  (download-quicklisp)
    ;;  (seq
    ;;    (load "quicklisp.lisp")
    ;;    (quicklisp-quickstart:install))
    ;;  (ql:add-to-init-file)
    ;;  ;; Move downloaded file to "${HOME}/quicklisp/quicklisp.lisp"
    ;;  (rename-file "quicklisp.lisp"
    ;;               (merge-pathnames "quicklisp.lisp" ql-dir)))
    ;; Initialize Quicklisp
    (sb-ext:run-program "/usr/bin/env" '("quicklisp" "init")
                        :input t :output t)
    (setq *first-run* t))
  (load ql-init))

#+asdf (require :asdf)
(ql:quickload :linedit :silent t)
(ql:quickload :cffi :silent t)

(defun pkg-config-add-lib (libname)
 (let ((process (sb-ext:run-program "/usr/bin/env"
                                    (list "pkg-config" libname "--libs-only-L")
                                    :input t :output :stream :wait t)))
  (let ((stream (sb-ext:process-output process)))
       (loop for line = (read-line stream nil nil)
        while line do
              ;; Drop "-L" part, and add '/' to the end. '/' IS necessary!
              (pushnew (pathname (concatenate 'string (subseq line 2) "/"))
                       cffi:*foreign-library-directories*))
       (sb-ext:process-close process))))

;; Get libssl
(pkg-config-add-lib "libssl")

(if (member "--no-lindedit" sb-ext:*posix-argv* :test 'equal)
  (setf sb-ext:*posix-argv*
        (remove "--no-linedit" sb-ext:*posix-argv* :test 'equal))
  (when (interactive-stream-p *terminal-io*)
    (require :sb-aclrepl)
    (linedit:install-repl :wrap-current t)))
